<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MemeSnap — Random Meme Generator</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%23805DE1'/%3E%3Cstop offset='1' stop-color='%233769E8'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='36' height='36' rx='8' fill='url(%23g)'/%3E%3Ccircle cx='13' cy='15' r='2' fill='white'/%3E%3Ccircle cx='23' cy='15' r='2' fill='white'/%3E%3Cpath d='M12 21 Q18 27 24 21' stroke='white' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E">

  <style>
    :root {
      --color-primary: 68 114 210;
      --color-on-primary: 255 255 255;
      --color-primary-container: 221 232 254;
      --color-on-primary-container: 26 48 95;
      --color-secondary: 126 93 209;
      --color-on-secondary: 255 255 255;
      --color-secondary-container: 232 228 254;
      --color-on-secondary-container: 54 38 94;
      --color-surface: 255 255 255;
      --color-on-surface: 15 15 15;
      --color-on-surface-variant: 50 65 87;
      --color-surface-container-low: 248 250 252;
      --color-surface-container: 241 245 249;
      --color-surface-container-high: 227 233 241;
      --color-inverse-surface: 29 41 58;
      --color-inverse-on-surface: 248 250 252;
      --color-outline-variant: 144 161 185;
      --color-scrim: 0 0 0;
      --color-shadow: 0 0 0;
      --color-error: 231 0 11;
      --color-success: 0 130 54;
      --color-success-container: 220 252 231;
      --color-gradient-primary: linear-gradient(135deg, rgb(53, 109, 232) 0%, rgb(23, 129, 175) 100%);
      --color-gradient-secondary: linear-gradient(135deg, rgb(128, 87, 221) 0%, rgb(55, 109, 232) 100%);

      --shadow-sm: 0 1px 3px rgb(var(--color-shadow) / 0.08), 0 1px 2px rgb(var(--color-shadow) / 0.06);
      --shadow-md: 0 4px 16px rgb(var(--color-shadow) / 0.10), 0 2px 6px rgb(var(--color-shadow) / 0.06);
      --shadow-lg: 0 8px 32px rgb(var(--color-shadow) / 0.12), 0 4px 12px rgb(var(--color-shadow) / 0.08);

      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-xl: 32px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }

    body {
      font-family: 'Outfit', sans-serif;
      background-color: rgb(var(--color-surface-container-low));
      color: rgb(var(--color-on-surface));
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-image:
        radial-gradient(circle at 20% 20%, rgb(var(--color-primary-container) / 0.5) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgb(var(--color-secondary-container) / 0.4) 0%, transparent 50%);
    }

    /* ── Header ── */
    .app-header {
      display: flex;
      align-items: center;
      padding: 16px 24px;
      background: rgb(var(--color-surface) / 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgb(var(--color-outline-variant) / 0.5);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .app-logo { display: flex; align-items: center; gap: 10px; }
    .app-logo-icon {
      width: 36px; height: 36px;
      background: var(--color-gradient-secondary);
      border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      color: rgb(var(--color-on-secondary));
    }
    .app-logo-icon svg { width: 20px; height: 20px; }
    .app-name {
      font-family: 'Syne', sans-serif;
      font-size: 1.25rem; font-weight: 800;
      background: var(--color-gradient-secondary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ── Icon button ── */
    .icon-btn {
      width: 40px; height: 40px;
      border-radius: var(--radius-sm);
      border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s, transform 0.1s;
      background: transparent;
      color: rgb(var(--color-on-surface-variant));
      text-decoration: none;
    }
    .icon-btn:hover { background: rgb(var(--color-surface-container-high)); color: rgb(var(--color-on-surface)); }
    .icon-btn:active { transform: scale(0.94); }
    .icon-btn svg { width: 20px; height: 20px; }

    /* ── Layout ── */
    .app-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 16px 48px;
      gap: 20px;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
    }

    /* ── Meme card ── */
    .meme-card {
      width: 100%;
      background: rgb(var(--color-surface));
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: box-shadow 0.2s;
    }
    .meme-card:hover { box-shadow: var(--shadow-lg); }

    /* Fixed aspect ratio prevents layout jump between meme loads */
    .meme-image-wrap {
      width: 100%;
      aspect-ratio: 4 / 3;
      position: relative;
      overflow: hidden;
      background: rgb(var(--color-surface-container));
      cursor: zoom-in;
    }
    .meme-image-wrap img {
      width: 100%; height: 100%;
      object-fit: contain;
      display: block;
      transition: opacity 0.3s, transform 0.3s;
    }
    .meme-image-wrap:hover img { transform: scale(1.02); }

    .state-overlay {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 12px;
      color: rgb(var(--color-on-surface-variant));
    }
    .state-overlay svg { width: 48px; height: 48px; opacity: 0.5; }
    .state-overlay p { font-size: 0.9rem; font-weight: 500; }

    .spinner {
      width: 48px; height: 48px;
      border: 3px solid rgb(var(--color-primary-container));
      border-top-color: rgb(var(--color-primary));
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .state-overlay.error svg { opacity: 1; color: rgb(var(--color-error)); }
    .state-overlay.error p  { color: rgb(var(--color-error)); }

    /* ── Card body ── */
    .meme-card-body { padding: 20px 24px 16px; }

    .meme-meta-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    /* Subreddit pill */
    .meme-subreddit {
      display: inline-flex; align-items: center; gap: 5px;
      font-size: 0.72rem; font-weight: 600;
      letter-spacing: 0.04em; text-transform: uppercase;
      color: rgb(var(--color-secondary));
      background: rgb(var(--color-secondary-container));
      padding: 3px 10px; border-radius: 100px;
      text-decoration: none;
      transition: opacity 0.15s;
    }
    .meme-subreddit:hover { opacity: 0.8; }
    .meme-subreddit svg { width: 11px; height: 11px; }

    /* Flair pill — color set inline via JS from link_flair_background_color */
    .meme-flair {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 0.68rem; font-weight: 600;
      letter-spacing: 0.03em;
      padding: 3px 8px; border-radius: 100px;
      background: rgb(var(--color-surface-container-high));
      color: rgb(var(--color-on-surface-variant));
    }

    .meme-title {
      font-family: 'Syne', sans-serif;
      font-size: 1.05rem; font-weight: 700; line-height: 1.4;
      color: rgb(var(--color-on-surface));
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Stats row: upvotes · comments · author */
    .meme-stats {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.8rem;
      color: rgb(var(--color-on-surface-variant));
    }
    .meme-stat {
      display: flex; align-items: center; gap: 5px;
      font-weight: 500;
    }
    .meme-stat svg { width: 14px; height: 14px; }

    /* Upvote ratio bar — subtle fill under the card stat row */
    .ratio-bar {
      height: 2px;
      background: rgb(var(--color-surface-container-high));
      border-radius: 100px;
      margin-top: 12px;
      overflow: hidden;
    }
    .ratio-fill {
      height: 100%;
      background: var(--color-gradient-primary);
      border-radius: 100px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ── Card actions ── */
    .meme-card-actions {
      display: flex; align-items: center; gap: 4px;
      padding: 8px 16px 14px;
    }
    .meme-card-actions .icon-btn { width: 36px; height: 36px; border-radius: var(--radius-sm); }
    .meme-card-actions .spacer { flex: 1; }

    /* Reddit link button — slightly different style to stand out as navigation */
    .btn-reddit {
      display: inline-flex; align-items: center; gap: 6px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.75rem; font-weight: 600;
      color: rgb(var(--color-on-surface-variant));
      background: rgb(var(--color-surface-container));
      border: none; border-radius: var(--radius-sm);
      padding: 6px 12px; cursor: pointer;
      text-decoration: none;
      transition: background 0.15s, color 0.15s;
    }
    .btn-reddit:hover {
      background: rgb(var(--color-surface-container-high));
      color: rgb(var(--color-on-surface));
    }
    .btn-reddit svg { width: 14px; height: 14px; }

    /* ── Generate button ── */
    .btn-generate {
      display: flex; align-items: center; justify-content: center; gap: 10px;
      width: 100%; padding: 16px 24px;
      border: none; border-radius: var(--radius-lg); cursor: pointer;
      font-family: 'Outfit', sans-serif; font-size: 1rem; font-weight: 600;
      color: rgb(var(--color-on-primary));
      background: var(--color-gradient-primary);
      box-shadow: 0 4px 16px rgb(var(--color-primary) / 0.35);
      transition: opacity 0.2s, transform 0.15s, box-shadow 0.2s;
      letter-spacing: 0.02em;
    }
    .btn-generate:hover:not(:disabled) {
      opacity: 0.92;
      box-shadow: 0 6px 20px rgb(var(--color-primary) / 0.45);
      transform: translateY(-1px);
    }
    .btn-generate:active:not(:disabled) { transform: translateY(0) scale(0.98); }
    .btn-generate:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-generate svg { width: 20px; height: 20px; transition: transform 0.5s; }
    .btn-generate.loading svg { animation: spin 1s linear infinite; }

    /* ── Lightbox — full-screen image view on click ── */
    .lightbox {
      position: fixed; inset: 0;
      background: rgb(var(--color-scrim) / 0.92);
      z-index: 400;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none;
      transition: opacity 0.2s;
      cursor: zoom-out;
    }
    .lightbox.open { opacity: 1; pointer-events: auto; }
    .lightbox img {
      max-width: 95vw; max-height: 92vh;
      object-fit: contain;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      transform: scale(0.95);
      transition: transform 0.2s;
    }
    .lightbox.open img { transform: scale(1); }
    .lightbox-close {
      position: absolute; top: 16px; right: 16px;
      width: 40px; height: 40px;
      border: none; border-radius: 50%; cursor: pointer;
      background: rgb(255 255 255 / 0.15);
      color: white;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s;
    }
    .lightbox-close:hover { background: rgb(255 255 255 / 0.25); }
    .lightbox-close svg { width: 20px; height: 20px; }

    /* ── Toast ── */
    .toast {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: rgb(var(--color-inverse-surface));
      color: rgb(var(--color-inverse-on-surface));
      padding: 12px 20px; border-radius: 100px;
      font-size: 0.875rem; font-weight: 500;
      display: flex; align-items: center; gap: 8px;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
      opacity: 0; z-index: 300; white-space: nowrap;
    }
    .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast svg { width: 16px; height: 16px; color: rgb(var(--color-success-container)); }

    /* ── Empty state ── */
    .empty-state {
      width: 100%;
      background: rgb(var(--color-surface));
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
      padding: 48px 24px;
      display: flex; flex-direction: column;
      align-items: center; gap: 12px;
      text-align: center;
      color: rgb(var(--color-on-surface-variant));
    }
    .empty-state-icon {
      width: 64px; height: 64px;
      background: rgb(var(--color-primary-container));
      border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center;
      color: rgb(var(--color-on-primary-container));
      margin-bottom: 4px;
    }
    .empty-state-icon svg { width: 32px; height: 32px; }
    .empty-state h2 {
      font-family: 'Syne', sans-serif;
      font-size: 1.2rem; font-weight: 700;
      color: rgb(var(--color-on-surface));
    }
    .empty-state p { font-size: 0.875rem; max-width: 280px; line-height: 1.5; }


    /* ── Hero section ── */
    .app-hero {
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      padding: 40px 16px 8px;
      text-align: center;
    }
    .app-hero-heading {
    font-family: 'Syne', sans-serif;
    font-size: 2.75rem;
    font-weight: 800;
    line-height: 1.28;
    letter-spacing: -0.02em;
    background: var(--color-gradient-secondary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 14px;
    }
    .app-hero-sub {
      font-size: 0.95rem;
      color: rgb(var(--color-on-surface-variant));
      max-width: 420px;
      margin: 0 auto 20px;
      line-height: 1.65;
    }
    .app-hero-badges {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }
    .app-hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      color: rgb(var(--color-on-surface-variant));
      background: rgb(var(--color-surface));
      border: 1px solid rgb(var(--color-outline-variant) / 0.6);
      border-radius: 100px;
      padding: 4px 12px;
      box-shadow: var(--shadow-sm);
    }
    .app-hero-badge svg { width: 12px; height: 12px; }
    @media (max-width: 480px) {
      .app-hero { padding: 28px 12px 4px; }
      .app-hero-heading { font-size: 2rem; }
    }

    @media (max-width: 480px) {
      .app-main { padding: 20px 12px 40px; }
      .meme-card-body { padding: 16px 16px 12px; }
      .meme-stats { gap: 10px; font-size: 0.75rem; }
    }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="app-logo">
      <div class="app-logo-icon"><i data-lucide="laugh"></i></div>
      <span class="app-name">MemeSnap</span>
    </div>
  </header>

  <!-- Hero — explains data origin upfront so users know what to expect before clicking Generate -->
  <section class="app-hero">
    <h1 class="app-hero-heading">Random Memes,<br>Instantly.</h1>
    <p class="app-hero-sub">Pulls real-time memes directly from Reddit's most popular communities — no account, no setup, just memes.</p>
    <div class="app-hero-badges">
      <span class="app-hero-badge"><i data-lucide="rss"></i>Live from Reddit</span>
      <span class="app-hero-badge"><i data-lucide="zap"></i>Instant &amp; free</span>
      <span class="app-hero-badge"><i data-lucide="shield-off"></i>No sign-in</span>
    </div>
  </section>

  <main class="app-main">

    <div class="meme-card" id="meme-card" style="display:none;">
      <div class="meme-image-wrap" id="meme-image-wrap">
        <img id="meme-img" src="" alt="Meme image" />
        <div class="state-overlay" id="img-state" style="display:none;"></div>
      </div>
      <div class="meme-card-body">
        <div class="meme-meta-row" id="meme-meta-row">
          <a class="meme-subreddit" id="meme-subreddit" href="#" target="_blank" rel="noopener noreferrer">
            <i data-lucide="rss"></i>
            <span id="meme-subreddit-label">r/memes</span>
          </a>
          <span class="meme-flair" id="meme-flair" style="display:none;"></span>
        </div>
        <h2 class="meme-title" id="meme-title">Loading meme…</h2>
        <div class="meme-stats" id="meme-stats">
          <span class="meme-stat" id="stat-score">
            <i data-lucide="arrow-up-circle"></i>
            <span id="stat-score-val">—</span>
          </span>
          <span class="meme-stat" id="stat-comments">
            <i data-lucide="message-circle"></i>
            <span id="stat-comments-val">—</span>
          </span>
          <span class="meme-stat" id="stat-author">
            <i data-lucide="user-round"></i>
            <span id="stat-author-val">—</span>
          </span>
        </div>
        <!-- Upvote ratio as a subtle progress bar — gives quick quality signal without explicit percentages -->
        <div class="ratio-bar"><div class="ratio-fill" id="ratio-fill" style="width:0%"></div></div>
      </div>
      <div class="meme-card-actions">
        <button class="icon-btn" id="btn-copy-link" title="Copy image link" aria-label="Copy image link">
          <i data-lucide="link"></i>
        </button>
        <button class="icon-btn" id="btn-open" title="Open image in new tab" aria-label="Open image in new tab">
          <i data-lucide="image"></i>
        </button>
        <div class="spacer"></div>
        <a class="btn-reddit" id="btn-reddit" href="#" target="_blank" rel="noopener noreferrer">
          <i data-lucide="external-link"></i>
          View on Reddit
        </a>
        <button class="icon-btn" id="btn-share" title="Share" aria-label="Share meme">
          <i data-lucide="share-2"></i>
        </button>
      </div>
    </div>

    <div class="empty-state" id="empty-state">
      <div class="empty-state-icon"><i data-lucide="image-plus"></i></div>
      <h2>Ready to Meme?</h2>
      <p>Hit the button below to pull a random meme from Reddit's best communities.</p>
    </div>

    <button class="btn-generate" id="btn-generate">
      <i data-lucide="shuffle"></i>
      <span id="btn-label">Generate Meme</span>
    </button>

  </main>

  <!-- Lightbox — full-screen zoom on image click -->
  <div class="lightbox" id="lightbox" role="dialog" aria-label="Full size image">
    <button class="lightbox-close" id="lightbox-close" aria-label="Close image">
      <i data-lucide="x"></i>
    </button>
    <img id="lightbox-img" src="" alt="Full size meme" />
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <i data-lucide="check-circle-2"></i>
    <span id="toast-msg">Copied!</span>
  </div>

  <script>
    lucide.createIcons();

    const SUBREDDITS = [
      "dankmemes", "PampamilyangPaoLUL", "NANIKPosting", "memes",
      "MemeTemplatesOfficial", "HistoryMemes", "Memes_Of_The_Dank",
      "meme", "dank_meme", "Animemes", "shitpost", "shitposting"
    ];

    const state = {
      loading: false,
      currentMeme: null, // { title, url, subreddit, score, numComments, author, flair, permalink, upvoteRatio }
    };

    const memeCard       = document.getElementById('meme-card');
    const emptyState     = document.getElementById('empty-state');
    const memeImg        = document.getElementById('meme-img');
    const memeImageWrap  = document.getElementById('meme-image-wrap');
    const imgState       = document.getElementById('img-state');
    const memeTitle      = document.getElementById('meme-title');
    const memeSubreddit  = document.getElementById('meme-subreddit');
    const memeSubLabel   = document.getElementById('meme-subreddit-label');
    const memeFlair      = document.getElementById('meme-flair');
    const statScoreVal   = document.getElementById('stat-score-val');
    const statCommentsVal= document.getElementById('stat-comments-val');
    const statAuthorVal  = document.getElementById('stat-author-val');
    const ratioFill      = document.getElementById('ratio-fill');
    const btnGenerate    = document.getElementById('btn-generate');
    const btnLabel       = document.getElementById('btn-label');
    const btnCopyLink    = document.getElementById('btn-copy-link');
    const btnOpen        = document.getElementById('btn-open');
    const btnShare       = document.getElementById('btn-share');
    const btnReddit      = document.getElementById('btn-reddit');
    const lightbox       = document.getElementById('lightbox');
    const lightboxImg    = document.getElementById('lightbox-img');
    const lightboxClose  = document.getElementById('lightbox-close');
    const toast          = document.getElementById('toast');
    const toastMsg       = document.getElementById('toast-msg');

    // ── Toast ──────────────────────────────────────────────────────────────
    let toastTimer = null;
    function showToast(msg) {
      toastMsg.textContent = msg;
      toast.classList.add('visible');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('visible'), 2500);
      lucide.createIcons({ attrs: {}, nameAttr: 'data-lucide', nodes: [toast] });
    }

    // ── Lightbox ───────────────────────────────────────────────────────────
    function openLightbox(src) {
      lightboxImg.src = src;
      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    function closeLightbox() {
      lightbox.classList.remove('open');
      document.body.style.overflow = '';
    }

    memeImageWrap.addEventListener('click', () => {
      if (state.currentMeme?.url) openLightbox(state.currentMeme.url);
    });
    lightboxClose.addEventListener('click', (e) => { e.stopPropagation(); closeLightbox(); });
    lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });

    // ── Number formatter — keeps big numbers readable (4701 → 4.7K) ──────
    function fmt(n) {
      if (n === undefined || n === null) return '—';
      if (n >= 1000) return (n / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
      return String(n);
    }

    // ── Render ─────────────────────────────────────────────────────────────
    function renderLoadingState() {
      imgState.style.display = 'flex';
      imgState.className = 'state-overlay';
      imgState.innerHTML = '<div class="spinner"></div><p>Finding a fresh meme…</p>';
      memeImg.style.opacity = '0';
    }

    function renderErrorState(message) {
      imgState.style.display = 'flex';
      imgState.className = 'state-overlay error';
      imgState.innerHTML = `<i data-lucide="wifi-off"></i><p>${message}</p>`;
      memeImg.style.opacity = '0';
      lucide.createIcons({ attrs: {}, nameAttr: 'data-lucide', nodes: [imgState] });
    }

    function renderMeme(meme) {
      emptyState.style.display = 'none';
      memeCard.style.display = 'block';

      memeTitle.textContent = meme.title || 'Untitled Meme';

      // Subreddit link goes straight to the subreddit for discovery
      memeSubLabel.textContent = `r/${meme.subreddit}`;
      memeSubreddit.href = `https://www.reddit.com/r/${meme.subreddit}/`;

      // Flair — only show when present and non-empty
      if (meme.flair) {
        memeFlair.textContent = meme.flair;
        memeFlair.style.display = 'inline-flex';
      } else {
        memeFlair.style.display = 'none';
      }

      statScoreVal.textContent = fmt(meme.score);
      statCommentsVal.textContent = fmt(meme.numComments);
      statAuthorVal.textContent  = meme.author ? `u/${meme.author}` : '—';

      // Upvote ratio bar gives a quick visual trust signal for the post quality
      ratioFill.style.width = `${Math.round((meme.upvoteRatio ?? 0.5) * 100)}%`;

      // Permalink links to the original Reddit discussion thread
      btnReddit.href = meme.permalink ? `https://www.reddit.com${meme.permalink}` : '#';

      lucide.createIcons({ attrs: {}, nameAttr: 'data-lucide', nodes: [memeCard] });

      memeImg.onload = () => {
        imgState.style.display = 'none';
        memeImg.style.opacity = '1';
      };
      memeImg.onerror = () => renderErrorState('Image failed to load');
      memeImg.src = meme.url;
    }

    function setLoading(loading) {
      btnGenerate.disabled = loading;
      btnGenerate.classList.toggle('loading', loading);
      btnLabel.textContent = loading ? 'Fetching meme…' : 'Generate Meme';
    }

    // ── Image URL extraction ────────────────────────────────────────────────
    // Reddit posts come in three shapes:
    //   1. Direct image: url_overridden_by_dest ends in .jpg/.jpeg/.png/.gif
    //   2. Gallery: is_gallery === true, images in media_metadata ordered by gallery_data.items
    //   3. Everything else: video, self-post, external link — skip

    function extractImageUrl(post) {
      if (post.is_video || post.is_self || post.over_18) return null;

      // Gallery — use the first image in the gallery order
      if (post.is_gallery && post.media_metadata && post.gallery_data?.items?.length) {
        const firstItem = post.gallery_data.items[0];
        const meta = post.media_metadata[firstItem.media_id];
        if (meta?.status === 'valid' && meta.s?.u) {
          // Reddit HTML-encodes the preview URL ampersands
          return meta.s.u.replace(/&amp;/g, '&');
        }
      }

      // Direct image post — url_overridden_by_dest holds the canonical image URL
      const url = post.url_overridden_by_dest || post.url || '';
      if (url.match(/\.(jpg|jpeg|png|gif)(\?|$)/i)) return url;

      return null;
    }

    // ── Core fetch ─────────────────────────────────────────────────────────
    async function fetchMeme() {
      if (state.loading) return;
      state.loading = true;
      setLoading(true);

      emptyState.style.display = 'none';
      memeCard.style.display = 'block';
      renderLoadingState();

      const MAX_ATTEMPTS = 10;
      let attempts = 0;

      while (attempts < MAX_ATTEMPTS) {
        attempts++;
        try {
          const src = SUBREDDITS[Math.floor(Math.random() * SUBREDDITS.length)];
          const res = await fetch(`https://www.reddit.com/r/${src}.json`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const dat = await res.json();

          // Build a candidate pool from all posts that have extractable images
          const candidates = dat.data.children
            .map(({ data }) => ({ data, url: extractImageUrl(data) }))
            .filter(({ url }) => !!url);

          if (!candidates.length) continue;

          const { data: post, url } = candidates[Math.floor(Math.random() * candidates.length)];

          state.currentMeme = {
            title: post.title,
            url,
            subreddit: post.subreddit || src,
            score: post.score,
            numComments: post.num_comments,
            author: post.author,
            flair: post.link_flair_text || null,
            permalink: post.permalink || null,
            upvoteRatio: post.upvote_ratio ?? null,
          };
          renderMeme(state.currentMeme);
          break;

        } catch (err) {
          console.warn(`[MemeSnap] attempt ${attempts} failed:`, err);
          if (attempts >= MAX_ATTEMPTS) {
            renderErrorState('Could not load meme — try again');
          }
        }
      }

      state.loading = false;
      setLoading(false);
    }

    // ── Card actions ────────────────────────────────────────────────────────
    btnCopyLink.addEventListener('click', async () => {
      if (!state.currentMeme?.url) return;
      try {
        await navigator.clipboard.writeText(state.currentMeme.url);
        showToast('Image link copied');
      } catch {
        showToast('Could not copy — try manually');
      }
    });

    btnOpen.addEventListener('click', () => {
      if (!state.currentMeme?.url) return;
      window.open(state.currentMeme.url, '_blank', 'noopener,noreferrer');
    });

    btnShare.addEventListener('click', async () => {
      if (!state.currentMeme) return;
      const shareUrl = state.currentMeme.permalink
        ? `https://www.reddit.com${state.currentMeme.permalink}`
        : state.currentMeme.url;
      if (navigator.share) {
        // Share the Reddit post link so recipients get full context, not just a raw image
        try {
          await navigator.share({ title: state.currentMeme.title, url: shareUrl });
        } catch { /* dismissed */ }
      } else {
        await navigator.clipboard.writeText(shareUrl).catch(() => {});
        showToast('Link copied (share not supported here)');
      }
    });

    btnGenerate.addEventListener('click', fetchMeme);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeLightbox();
    });
  </script>
</body>
</html>
